<!DOCTYPE html>
<html>

<head>
    <title>AR.js A-Frame Location-based</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js'></script>
</head>

<body>
    <a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false'
        renderer='antialias: true; alpha: true'>
        <a-camera gps-new-camera='gpsMinDistance: 3'></a-camera>
    </a-scene>

    <script>
        window.onload = async () => {
            let boxAdded = false;
            let textEntity = null;
            let currentTargetIndex = null;
            let targets = [];

            try {
                // Chamada para API que retorna os destinos
                const response = await fetch('targets.json');
                targets = await response.json(); // Espera resposta JSON no formato [{ latitude, longitude, message, tolerance }, ...]
                console.log("Destinos carregados:", targets);
            } catch (error) {
                alert("Erro ao carregar destinos da API");
                console.error(error);
                return;
            }

            const el = document.querySelector("[gps-new-camera]");
            el.addEventListener("gps-camera-update-position", e => {
                const userLat = e.detail.position.latitude;
                const userLon = e.detail.position.longitude;

                if (!boxAdded) {
                    const entity = document.createElement("a-box");
                    entity.setAttribute("scale", { x: 20, y: 20, z: 20 });
                    entity.setAttribute('material', { color: 'red' });
                    entity.setAttribute('gps-new-entity-place', {
                        latitude: userLat + 0.001,
                        longitude: userLon
                    });
                    document.querySelector("a-scene").appendChild(entity);
                    boxAdded = true;
                }

                let foundTarget = null;
                let foundIndex = null;
                for (let i = 0; i < targets.length; i++) {
                    const t = targets[i];
                    const isNear = Math.abs(userLat - t.latitude) < t.tolerance &&
                        Math.abs(userLon - t.longitude) < t.tolerance;

                    if (isNear) {
                        foundTarget = t;
                        foundIndex = i;
                        break;
                    }
                }

                if (foundTarget && textEntity == null) {
                    alert(`Usuário chegou: ${foundTarget.message}`);
                    textEntity = document.createElement("a-text");
                    textEntity.setAttribute("value", foundTarget.message);
                    textEntity.setAttribute("look-at", "[gps-new-camera]");
                    textEntity.setAttribute("scale", "20 20 20");
                    textEntity.setAttribute("gps-new-entity-place", {
                        latitude: foundTarget.latitude,
                        longitude: foundTarget.longitude
                    });
                    document.querySelector("a-scene").appendChild(textEntity);
                    currentTargetIndex = foundIndex;
                }

                if ((!foundTarget || foundIndex !== currentTargetIndex) && textEntity != null) {
                    alert(`Você se afastou do destino anterior: ${userLat} e ${userLon}`);
                    textEntity.parentNode.removeChild(textEntity);
                    textEntity = null;
                    currentTargetIndex = null;
                }

                if (!foundTarget && !textEntity) {
                    alert(`Você não está próximo de nenhum destino ${userLat} e ${userLon}`);
                }
            });
        };
    </script>

</body>

</html>