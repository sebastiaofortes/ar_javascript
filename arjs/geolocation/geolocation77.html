<!DOCTYPE html>
<html>

<head>
    <title>AR.js A-Frame Location-based</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript'
        src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js'></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>

<body>
    <a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false'
        renderer='antialias: true; alpha: true'>
        <a-camera gps-new-camera='gpsMinDistance: 10' cursor="rayOrigin: mouse"
            raycaster="far: 100; objects: .clickable">
            <a-entity id="loadingStatus" position="0 0 -1"
                text="value: Carregando...; color: white; align: center; width: 2">
            </a-entity>
        </a-camera>
        <a-assets>
            <video id="meuVideo" autoplay loop="true" src="vv2.webm"></video>
        </a-assets>
    </a-scene>
    <script>

        // Para serem clicáveis os objetos precisam estar a uma distãncia menor que 0,001
        // Isso ocorre devido a minha configuração de raycaster 
        const positionConfigs = [
            { lat: -0.00005, long: -0.00007, id: 'Box1N', color: 'yellow', descricao: 'Atrás à esquerda' },
            { lat: -0.00007, long: 0, id: 'Box2N', color: 'blue', descricao: 'Atrás' },
            { lat: -0.00005, long: 0.00007, id: 'Box3N', color: 'black', descricao: 'Atrás à direita' },
            { lat: 0.00007, long: 0, id: 'Box4N', color: 'red', descricao: 'Frente' },
            { lat: 0, long: 0.00007, id: 'Box5N', color: 'green', descricao: 'Lado direito' },
            { lat: 0, long: -0.00007, id: 'Box6N', color: 'pink', descricao: 'Lado esquerdo' }
        ];

        window.onload = () => {
            let testEntityAdded = false;

            const el = document.querySelector("[gps-new-camera]");

            el.addEventListener("gps-camera-update-position", e => {
                if (!testEntityAdded) {

                    // Modelo GLTF
                    const model = document.createElement("a-gltf-model");
                    model.setAttribute("src", "scene.gltf");
                    model.setAttribute("scale", "5 5 5");
                    model.setAttribute("rotation", "0 -90 0")
                    model.setAttribute("gps-new-entity-place", {
                        latitude: e.detail.position.latitude + 0.0005,
                        longitude: e.detail.position.longitude + 0.0002
                    });
                    document.querySelector("a-scene").appendChild(model);

                    // Desenha acoruja
                    GeneratePlane(e, -0.00007, 0, 'Box2N');

                    // Remove carregando...
                    document.getElementById('loadingStatus').setAttribute('visible', 'false');
                    //alert(`Got first GPS position: lon ${e.detail.position.longitude} lat ${e.detail.position.latitude}`);
                }
                testEntityAdded = true;
            });
        };

        function GenerateCubes(e, latVal, longVal, idv, colorv) {
            // Add a box to the north of the initial GPS position
            const entity = document.createElement("a-box");
            entity.setAttribute("scale", {
                x: 20,
                y: 20,
                z: 20
            });
            entity.setAttribute('id', idv);
            entity.setAttribute('class', 'clickable');
            entity.setAttribute('material', { color: colorv });
            entity.setAttribute('gps-new-entity-place', {
                latitude: e.detail.position.latitude + latVal,
                longitude: e.detail.position.longitude + longVal
            });
            entity.addEventListener("click", () => {
                alert(entity.id);
            });
            entity.setAttribute('opacity', '0.6')
            document.querySelector("a-scene").appendChild(entity);


        }

        function GeneratePlane(e, latVal, longVal, idv) {
            // Plane
            const plane = document.createElement('a-plane');
            plane.setAttribute('id', idv);
            plane.setAttribute('width', 8);
            plane.setAttribute('height', 4);
            plane.setAttribute('animation__in', {
                property: 'scale',
                from: '0 0 0',
                to: '4 2 1',
                dur: 1000,
                easing: 'easeOutElastic'
            });
            // faz com que o plano rotacione para sempre ficar virado para a câmera,
            // necessário dependência <!-- <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
            plane.setAttribute('look-at', '[gps-new-camera]');
            plane.setAttribute("gps-new-entity-place", {
                latitude: e.detail.position.latitude + latVal,
                longitude: e.detail.position.longitude + longVal
            });
            plane.setAttribute('material', 'src: #meuVideo');
            plane.setAttribute('transparent', 'true');
            plane.setAttribute('class', 'clickable');
            plane.addEventListener("click", () => {
                plane.setAttribute('animation__out', {
                    property: 'scale',
                    to: '0 0 0',
                    dur: 500,
                    easing: 'easeInBack'
                });

                setTimeout(() => {

                    const newPosition = getRandomPositionConfig(e);
                    plane.setAttribute('gps-new-entity-place', {
                        latitude: e.detail.position.latitude + newPosition.lat,
                        longitude: e.detail.position.longitude + newPosition.long
                    });

                    // Reaplica a animação de entrada após o reposicionamento
                    plane.setAttribute('animation__in', {
                        property: 'scale',
                        from: '0 0 0',
                        to: '4 2 1',
                        dur: 1000,
                        easing: 'easeOutElastic'
                    });

                }, 600); // Espera a animação de saída terminar


            });
            document.querySelector("a-scene").appendChild(plane);
        }

        function getRandomPositionConfig(e) {
            const index = Math.floor(Math.random() * positionConfigs.length);
            return positionConfigs[index];
        }

    </script>
</body>

</html>