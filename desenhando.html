<!DOCTYPE html>
<html>
  <head>
    <title>Detectar Caminhada e Direção</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/ar.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; gpsMinAccuracy: 100; gpsTimeInterval: 1000;"
    >
      <a-camera gps-new-camera="gpsMinDistance: 1;" rotation-reader></a-camera>

      <!-- Objeto alvo -->
      <a-box
        id="target-box"
        color="blue"
        depth="2" height="2" width="2"
        gps-entity-place="latitude: -23.5629; longitude: -46.6544"
      ></a-box>

      <script>
        const camera = document.querySelector('[gps-new-camera]');
        const target = document.getElementById('target-box');

        function isUserFacingTarget() {
          const camPos = new THREE.Vector3();
          camera.object3D.getWorldPosition(camPos);

          const targetPos = new THREE.Vector3();
          target.object3D.getWorldPosition(targetPos);

          const camDir = new THREE.Vector3();
          camera.object3D.getWorldDirection(camDir);

          const toTarget = new THREE.Vector3();
          toTarget.subVectors(targetPos, camPos).normalize();

          const angle = camDir.angleTo(toTarget) * (180 / Math.PI);

          return angle < 25; // ângulo ajustável
        }

        window.addEventListener('devicemotion', (event) => {
          const acc = event.accelerationIncludingGravity;
          const totalAcc = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);

          if (totalAcc > 18) {
            if (isUserFacingTarget()) {
              console.log('Caminhando na direção do cubo!');
              target.setAttribute('color', 'lime');
            }
          }
        });
      </script>
    </a-scene>
  </body>
</html>
